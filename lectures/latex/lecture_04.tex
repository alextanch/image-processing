\documentclass[
    12pt, 
    usepdftitle=false,
    aspectratio=1610
]{beamer}

\usetheme{Madrid}

\usefonttheme[]{serif}
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{navigation symbols}{}

\usepackage[T2A]{fontenc}			
\usepackage[utf8]{inputenc}			
\usepackage[english,russian]{babel}

\usepackage{
    mathtext,
    minted,
    cmap,
    multirow,
    textcomp,
    graphicx,
    wrapfig,
    subfig,
    mathtools,
    gensymb
}
\usepackage[font=small,labelfont=bf]{caption}

\DeclarePairedDelimiter{\norm}{\lVert}{\rVert} 

\graphicspath{{./figs/04}}

\title[Лекция 4]{Детекция границ и линий на изображениях}

\author{Александр Танченко}
\institute{}
\date{2025}

\begin{document}

%------------------------------------------------------------
\begin{frame}
    \titlepage
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Задачи детекции границ и линий на изображениях}
\begin{figure}
    \centering
    \includegraphics[height=0.4\textheight]{edge_detection.jpg}
    \includegraphics[height=0.4\textheight]{line_detection.jpg}
\end{figure}
\textbf{edge detection} -- это задача сегментации изображения
$$
   f(x,y)\quad\mapsto\quad e(x,y)\in\left\{0,1\right\}
$$
\textbf{line detection} -- это задача детектирования объектов на изображении
$$
    f(x,y)\quad\mapsto\quad e(x,y)\quad\mapsto\quad\mbox{line}
$$
\end{frame}

%------------------------------------------------------------
\begin{frame}
    \frametitle{Детекция границ на изображениях}
\begin{figure}
    \centering
    \includegraphics[height=0.25\textheight]{edge_samples.pdf}
    \includegraphics[height=0.25\textheight]{edge_model_1.pdf}
    \hspace*{3cm}
    \includegraphics[height=0.25\textheight]{edge_model_2.pdf}
\end{figure}
Общая схема алгоритмов детектирования границ на изображении:
\begin{itemize}
    \item сгладить изображение
    \item вычислить производные используя свертки
    \item выполнить постпроцессинг
\end{itemize}
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Сглаживание изображения}
\begin{figure}
    \centering
    \includegraphics[height=0.4\textheight]{gauss_blur.png}
\end{figure}
Гауссовский фильтр
$$
    g=G\circ f
$$
Гауссовское ядро
$$
    G(s,t)=K\cdot\exp\left\{-\frac{s^2+t^2}{2\sigma_s^2}\right\}
    \qquad n=2k+1
    \qquad k=\lceil 3\sigma_s \rceil
$$
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Производные Собела}
\begin{figure}
    \centering
    \includegraphics[height=0.2\textheight]{sobel1.pdf}
    \hspace*{0.5cm}
    \includegraphics[height=0.2\textheight]{sobel2.pdf}
    \hspace*{0.5cm}
    \includegraphics[height=0.2\textheight]{building.png}
    \hspace*{0.5cm}
    \includegraphics[height=0.2\textheight]{sobel_y.png}
    \hspace*{0.5cm}
    \includegraphics[height=0.2\textheight]{sobel_x.png}
\end{figure}
Производные Собела
$$
    f'_y(x,y)=\frac{\partial f}{\partial y}\approx
    \frac{(z_7+2z_8+z_9)-(z_1+2z_2+z_3)}{4}=S_y\circ f
$$
$$
    f'_x(x,y)=\frac{\partial f}{\partial x}\approx
    \frac{(z_3+2z_6+z_9)-(z_1+2z_4+z_7)}{4}=S_x\circ f
$$
Ядра Собела
$$
    S_y=
    \frac{1}{4}
    \begin{bmatrix}
        1 & 2 & 1 \\
        0 & 0 & 0 \\
        -1 & -2 & -1 \\
    \end{bmatrix}
    \qquad
    S_x=\frac{1}{4}
    \begin{bmatrix}
        1 & 0 & -1 \\
        2 & 0 & -2 \\
        1 & 0 & -1 \\
    \end{bmatrix}
$$
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Градиент изображения}
\begin{figure}
    \centering
    \includegraphics[height=0.3\textheight]{building.png}
    \hspace*{0.5cm}
    \includegraphics[height=0.3\textheight]{gradient.png}
    \hspace*{0.5cm}
    \includegraphics[height=0.3\textheight]{gradient.pdf}
\end{figure}
Производные Собела
$$
    f'_x\approx S_x\circ f\qquad
    f'_y\approx S_y\circ f
$$
Градиент, его модуль и направление 
$$
    \nabla f = \left(f'_x\,, f'_y\right)\qquad
    \norm{\nabla f}=\sqrt{\left(f'_x\right)^2+\left(f'_y\right)^2}\qquad
    \alpha=\arctan\left(\frac{f'_x}{f'_y}\right)
$$
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Детектор границ Собела}
\begin{itemize}
    \item сгладить изображение гауссовским фильтром
    $$
        g = G \circ f
    $$
    \item вычислить частные производные используя свертки с ядрами Собеля
    $$
        g_x=S_x\circ g
        \qquad
        g_y=S_y\circ g
    $$
    \item вычислить модуль градиента
    $$
        m(x,y) =\sqrt{g_x^2+g_y^2}
    $$
    \item выполнить постпроцессинг с порогом $T$
    $$
        e(x, y) =
        \begin{cases}
            1\,, & m(x,y) > T\quad \mbox{-- пиксель принадлежит границе}\\
            0\,, & m(x,y) \leqslant T\quad\mbox{-- пиксель не принадлежит границе}
        \end{cases}
    $$
\end{itemize}
\end{frame}


%------------------------------------------------------------
\begin{frame}
\frametitle{Детектор границ Кэнни}
\begin{figure}
    \centering
    \includegraphics[height=0.2\textheight]{gradient1.pdf}
    \hspace{1cm}
    \includegraphics[height=0.2\textheight]{gradient2.png}
\end{figure}
\begin{itemize}
    \item вычислить модуль и направление градиента сглаженного изображения
    $$
        m(x,y) =
            \sqrt{g_x^2+g_y^2}\qquad
            \alpha(x,y)=\arctan\left(\frac{g_x}{g_y}\right)
    $$
    \item находим направление $d_k$, $k=1,2,3,4$ ближайшее к $\alpha(x,y)$
    \item формируем новое изображение
    $$
        t(x, y) =
        \begin{cases}
            m(x,y)\,, & \quad \mbox{если}\,\, m(x,y)\,\,\mbox{больше чем у соседей в направлении}\,\,d_k\\
            0\,, & \quad\mbox{в противном случае}
        \end{cases}
    $$
    \item для двух порогов $T_1>T_2$, $(x,y)$ -- точка границы, если
    $$
        t(x,y) > T_1
        \quad\mbox{или}\quad
        t(x_i, y_i) > T_2\,\,
        \mbox{для 8-и соседей пикселя}\,\, (x,y)
    $$
\end{itemize}
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Вычисление оператора Лапласа}
\begin{figure}
    \centering
    \includegraphics[height=0.3\textheight]{sobel1.pdf}
\end{figure}
    девятиточечная разностная схема для оператора Лапласа
    $$
        \Delta f(x,y)\approx 
        (z_1+z_2+z_3+z_4+z_6+z_7+z_8+z_9)-8z_5
    $$
    фильтр Лапласа
    $$
        \Delta f\approx L \circ f
    $$
    ядро свертки фильтра Лапласа
    $$
        L =
        \begin{bmatrix*}[r]
            1 & 1 & 1 \\
            1 & -8 & 1 \\
            1 & 1 & 1
        \end{bmatrix*}
    $$
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Детектор границ Марра-Хилдрета}
\begin{figure}
    \centering
    \includegraphics[height=0.35\textheight]{zero_crossing.pdf}
    \hspace{1cm}
    \includegraphics[height=0.15\textheight]{gradient2.png}
\end{figure}
\begin{itemize}
    \item сгладить изображение гауссовским фильтром
    $$
        g = G \circ f
    $$

    \item вычислить оператор Лапласа от сглаженного изображения
    $$
        \Delta g\approx
        L\circ g=L\circ G \circ f=\mathrm{LoG}\qquad
    $$
    \item для порога $T$, $(x,y)$ -- точка границы, если у хотя бы одной из четырех пар
    $$
        \mathrm{LoG}(x_i,y_i)\cdot\mathrm{LoG}(x_j,y_j)<0
        \quad\mbox{и}\quad
        \left|\mathrm{LoG}(x_i,y_i)-\mathrm{LoG}(x_j,y_j)\right| > T
    $$
    
\end{itemize}
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Уравнения прямых на плоскости}
\begin{itemize}
    \item задание прямой с помощью расстояния и нормали
    $$
        d=
        \begin{bmatrix}
            x\quad y
        \end{bmatrix}
        \cdot
        \begin{bmatrix}
            n_x \\ n_y
        \end{bmatrix}=
        x\cos\theta+y\sin\theta
    $$
    \item задание прямой с помощью точки на прямой и направляющего вектора
    $$
        \begin{bmatrix}
            x \\ y
        \end{bmatrix} =
        \begin{bmatrix}
            x_0 \\ y_0
        \end{bmatrix}+
        s\cdot \begin{bmatrix}
            t_x \\ t_y
        \end{bmatrix}
    $$
    \item нормаль к прямой и её направляющий вектор
    \begin{align*}
        t_x &= -n_y \\
        t_y &= n_x
    \end{align*}
\end{itemize}
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Преобразование Хафа}
\begin{figure}
    \centering
    \includegraphics[height=0.25\textheight]{hough1.png}
    \hspace{1cm}
    \includegraphics[height=0.25\textheight]{hough2.png}
\end{figure}
\begin{itemize}
    \item каждой прямой на плоскости $(x,y)$ соответствует точка на плоскости $(\theta, d)$
    \item каждой точке на плоскости $(x,y)$ соответствует кривая на плоскости $(\theta, d)$ 
    $$
        d=x\cos\theta+y\sin\theta
    $$
    \item всем точкам прямой на плоскости $(x,y)$ соответствуют кривые, пересекающиеся в одной точке на плоскости $(\theta, d)$ 
\end{itemize}
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Поиск прямых с помощью преобразования Хафа}
\begin{figure}
    \centering
    \includegraphics[height=0.4\textheight]{hough3.png}
\end{figure}
\begin{figure}
    \centering
    \includegraphics[height=0.4\textheight]{hough4.png}
\end{figure}
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Robust line estimation}
\begin{figure}
    \centering
    \includegraphics[height=0.3\textheight]{ransac1.pdf}
\end{figure}
\begin{itemize}
    \item по множеству точек на плоскости, содержащее выбросы (outliers) требуется найти прямую
    $$
        \mathbf{S}=\left\{(x_i, y_i)\right\}_{i=1}^I
        \quad\mapsto\quad
        \mathbf{L}(x_0,y_0,t_x,t_y):\quad
        \begin{bmatrix}
            x \\ y
        \end{bmatrix} =
        \begin{bmatrix}
            x_0 \\ y_0
        \end{bmatrix}+
        s\cdot \begin{bmatrix}
            t_x \\ t_y
        \end{bmatrix}
    $$
    \item метод наименьших квадратов даст плохой результат
    \item нужен робастный (устойчивый к выбросам) алгоритм оценки параметров модели прямой
\end{itemize}
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{RANSAC (RANdom SAmple Consensus)}
\begin{figure}
    \centering
    \includegraphics[height=0.2\textheight]{ransac2.pdf}
\end{figure}
Задаем порог $T$ и число повторений $N$
\begin{itemize}
    \item[1.] \textbf{robust estimation}: для $n=1,2,\ldots,N$ повторить
    \begin{itemize}
        \item[(a)] выбрать две случайных точки из $\mathbf{S}$
                   и по ним построить прямую $\mathbf{L}_n$
        \item[(b)] разделить точки из $\mathbf{S}$ на inliers и outliers по порогу $T$
            $$
            \mathrm{dist}\left((x_i,y_i),\mathbf{L}_n\right)<T
            $$
    \end{itemize} 
    \item[2.] выбрать $\mathbf{L}_n$ c наибольшим числом inliers $\mathbf{S}_i$
    \item[3.] \textbf{optimal estimation}: оценить финальную прямую  $\mathbf{L}$ на точках из  $\mathbf{S}_i$
\end{itemize}
\end{frame}

%------------------------------------------------------------
\begin{frame}
\frametitle{Пример: поиск прямых с помощью RANSAC}
\begin{figure}
    \centering
    \includegraphics[height=0.4\textheight]{line_ransac.jpg}
    \includegraphics[height=0.4\textheight]{marr_hildreth_edges.jpg}
\end{figure}
\begin{itemize}
    \item поиск границ с помощью алгоритма Марра-Хилдрета
    \item RANSAC с параметрами
    $$
        T=10\qquad N=10000
    $$
    \item порог $T$ и число повторений $N$ обычно оцениваются адаптивно, исходя из статистических свойств данных
\end{itemize}
\end{frame}

%------------------------------------------------------------
% \begin{frame}
% \frametitle{Фильтр Лапласа}
% \begin{figure}
%     \centering
%     \includegraphics[height=0.4\textheight]{laplace_filter.png}
% \end{figure}
% Разностная схема для оператора Лапласа
% $$
%     \Delta f=
%     \frac{\partial^2 f}{\partial x^2}+\frac{\partial^2 f}{\partial y^2}\approx
%     L\bullet f=L\circ f
% $$
% Ядро Лапласа
% $$
%     L =
%     \begin{bmatrix*}[r]
%         1 & 1 & 1 \\
%         1 & -8 & 1 \\
%         1 & 1 & 1
%     \end{bmatrix*}
% $$
% \end{frame}

\end{document}

%------------------------------------------------------------
\begin{frame}
\frametitle{}
\end{frame}
